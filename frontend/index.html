<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitcoin Regtest Dashboard</title>
  <style>
    :root {
      --bg-primary: #0a0f17;
      --bg-secondary: #111827;
      --bg-tertiary: #1f2937;
      --border-color: #374151;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --accent-orange: #3b82f6;
      --accent-green: #238636;
      --accent-red: #da3633;
      --accent-blue: #58a6ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo svg {
      width: 40px;
      height: 40px;
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .logo span {
      color: var(--accent-orange);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-red);
    }

    .status-dot.connected {
      background: var(--accent-green);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-card h3 {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: clamp(1rem, 3vw, 1.8rem);
      font-weight: 600;
      color: var(--accent-orange);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stat-card .value.wrap-ok {
      white-space: normal;
      word-break: break-all;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.95rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent-orange);
      border-bottom-color: var(--accent-orange);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-orange);
    }

    .form-group textarea {
      min-height: 100px;
      font-family: monospace;
      resize: vertical;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-orange);
      color: #000;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-orange);
      cursor: pointer;
    }

    .checkbox-group label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      margin: 0;
    }

    .result-box {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-family: monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-box.success {
      border-color: var(--accent-green);
    }

    .result-box.error {
      border-color: var(--accent-red);
      color: var(--accent-red);
    }

    .inline-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .inline-form .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background: var(--bg-tertiary);
    }

    .truncate {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .badge-success {
      background: rgba(35, 134, 54, 0.2);
      color: var(--accent-green);
    }

    .badge-warning {
      background: rgba(247, 147, 26, 0.2);
      color: var(--accent-orange);
    }

    .badge-danger {
      background: rgba(218, 54, 51, 0.2);
      color: var(--accent-red);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .copy-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .copy-btn:hover {
      color: var(--text-primary);
    }

    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .quick-action-btn {
      padding: 16px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }

    .quick-action-btn:hover {
      border-color: var(--accent-orange);
      transform: translateY(-2px);
    }

    .quick-action-btn svg {
      width: 28px;
      height: 28px;
      color: var(--accent-orange);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-orange);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .regtest-only.disabled {
      opacity: 0.5;
      pointer-events: none;
      position: relative;
    }

    .regtest-only.disabled::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      cursor: not-allowed;
    }

    .network-warning {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid #eab308;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      color: #eab308;
      display: none;
    }

    .network-warning.visible {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .network-warning svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Theme Panel Styles */
    .settings-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      color: var(--text-primary);
      border-color: var(--accent-orange);
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
    }

    .theme-panel {
      position: fixed;
      top: 0;
      right: -320px;
      width: 320px;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      padding: 24px;
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }

    .theme-panel.open {
      right: 0;
    }

    .theme-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }

    .theme-panel-overlay.open {
      display: block;
    }

    .theme-panel h3 {
      font-size: 1.2rem;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .theme-panel .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
    }

    .theme-panel .close-btn:hover {
      color: var(--text-primary);
    }

    .color-option {
      margin-bottom: 20px;
    }

    .color-option label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .color-picker-wrapper input[type="color"] {
      width: 50px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: none;
    }

    .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .color-picker-wrapper input[type="color"]::-webkit-color-swatch {
      border: 2px solid var(--border-color);
      border-radius: 6px;
    }

    .color-picker-wrapper input[type="text"] {
      flex: 1;
      padding: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: monospace;
      font-size: 0.9rem;
    }

    .theme-presets {
      margin-bottom: 24px;
    }

    .theme-presets label {
      display: block;
      margin-bottom: 10px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .preset-btn {
      width: 100%;
      aspect-ratio: 1;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover {
      transform: scale(1.1);
    }

    .preset-btn.active {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 2px var(--bg-primary);
    }

    .theme-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }

    .theme-actions button {
      flex: 1;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .inline-form {
        flex-direction: column;
      }
      .inline-form .form-group {
        width: 100%;
      }
      .theme-panel {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg viewBox="0 90.7 612 611.1" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
          <path fill="#3b82f6" d="M602.7,470c-40.8,163.6-206.6,263.5-370.6,222.7C68.4,651.8-31.4,486.1,9.4,322.5S215.9,59,379.5,99.8C543.6,140.1,643.4,306.3,602.7,470z"/>
          <path fill="#FFFFFF" d="M450.9,356.5c5.5-40.8-25.5-62.1-68-76.5l13.2-55.2l-33.6-8.1l-12.8,54c-8.9-2.1-17.9-4.2-26.8-6l12.8-54l-34-8.1l-13.2,55.2c-7.2-1.7-14.5-3-21.7-4.7l0,0l-46.3-11.1l-8.5,35.7c0,0,25.1,5.5,24.2,6c13.6,3.4,16.2,12.3,15.7,19.1l-14.9,62.9c0.9,0.4,2.1,0.4,3.4,1.3c-1.3-0.4-2.1-0.4-3.4-0.8l-20.4,88c-1.7,4.2-6,10.2-15.3,8.1c0.4,0.4-24.7-6-24.7-6L160.7,495l43.8,10.2c8.1,2.1,16.2,3.8,23.8,6l-13.2,55.7l33.6,8.1l13.2-55.2c9.4,2.5,18.3,4.7,26.8,6.8l-13.2,54.8l33.6,8.1l13.2-55.7c57.4,10.2,100.3,5.5,117.7-46.8c14-41.7-1.3-65.5-31.9-81.2C430.5,400.7,446.7,386.2,450.9,356.5zM375.3,464.8c-9.8,41.7-80.3,20-102.9,14.5l17.4-74C312.8,410.9,385.5,421.1,375.3,464.8zM384.6,356.5c-8.9,37.8-67.6,19.6-86.7,14.9l16.2-67.1C332.8,308.9,394,317,384.6,356.5z"/>
        </svg>
        <h1>Regtest <span>Dashboard</span></h1>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="status-indicator" title="Bitcoin Core">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Connecting...</span>
        </div>
        <div class="status-indicator" title="Electrs">
          <div class="status-dot" id="electrsStatusDot"></div>
          <span id="electrsStatusText">Electrs...</span>
        </div>
        <button class="settings-btn" onclick="toggleThemePanel()" title="Theme Settings">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Theme Panel -->
    <div class="theme-panel-overlay" id="themePanelOverlay" onclick="toggleThemePanel()"></div>
    <div class="theme-panel" id="themePanel">
      <h3>
        Theme Settings
        <button class="close-btn" onclick="toggleThemePanel()">&times;</button>
      </h3>

      <div class="theme-presets">
        <label>Dark Themes</label>
        <div class="preset-grid">
          <button class="preset-btn" style="background: #f7931a;" onclick="applyPreset('bitcoin')" title="Bitcoin Orange"></button>
          <button class="preset-btn" style="background: #22c55e;" onclick="applyPreset('green')" title="Green"></button>
          <button class="preset-btn" style="background: #3b82f6;" onclick="applyPreset('blue')" title="Blue"></button>
          <button class="preset-btn" style="background: #a855f7;" onclick="applyPreset('purple')" title="Purple"></button>
          <button class="preset-btn" style="background: #ef4444;" onclick="applyPreset('red')" title="Red"></button>
          <button class="preset-btn" style="background: #ec4899;" onclick="applyPreset('pink')" title="Pink"></button>
          <button class="preset-btn" style="background: #14b8a6;" onclick="applyPreset('teal')" title="Teal"></button>
          <button class="preset-btn" style="background: #eab308;" onclick="applyPreset('yellow')" title="Yellow"></button>
        </div>
      </div>

      <div class="theme-presets">
        <label>Light Themes</label>
        <div class="preset-grid">
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #3b82f6 50%);" onclick="applyPreset('lightBlue')" title="Light Blue"></button>
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #22c55e 50%);" onclick="applyPreset('lightGreen')" title="Light Green"></button>
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #a855f7 50%);" onclick="applyPreset('lightPurple')" title="Light Purple"></button>
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #f7931a 50%);" onclick="applyPreset('lightOrange')" title="Light Orange"></button>
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #64748b 50%);" onclick="applyPreset('lightGray')" title="Light Gray"></button>
          <button class="preset-btn" style="background: linear-gradient(135deg, #f8fafc 50%, #14b8a6 50%);" onclick="applyPreset('lightTeal')" title="Light Teal"></button>
        </div>
      </div>

      <div class="color-option">
        <label>Accent Color</label>
        <div class="color-picker-wrapper">
          <input type="color" id="accentColor" value="#3b82f6" onchange="updateColor('accent', this.value)">
          <input type="text" id="accentColorText" value="#3b82f6" onchange="updateColorFromText('accent', this.value)">
        </div>
      </div>

      <div class="color-option">
        <label>Background</label>
        <div class="color-picker-wrapper">
          <input type="color" id="bgColor" value="#0a0f17" onchange="updateColor('bg', this.value)">
          <input type="text" id="bgColorText" value="#0a0f17" onchange="updateColorFromText('bg', this.value)">
        </div>
      </div>

      <div class="color-option">
        <label>Card Background</label>
        <div class="color-picker-wrapper">
          <input type="color" id="cardColor" value="#111827" onchange="updateColor('card', this.value)">
          <input type="text" id="cardColorText" value="#111827" onchange="updateColorFromText('card', this.value)">
        </div>
      </div>

      <div class="color-option">
        <label>Text Color</label>
        <div class="color-picker-wrapper">
          <input type="color" id="textColor" value="#f0f6fc" onchange="updateColor('text', this.value)">
          <input type="text" id="textColorText" value="#f0f6fc" onchange="updateColorFromText('text', this.value)">
        </div>
      </div>

      <div class="theme-actions">
        <button class="btn btn-secondary" id="themeResetBtn" onclick="resetTheme()">Reset</button>
        <button class="btn btn-primary" id="themeDoneBtn" onclick="toggleThemePanel()">Done</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Block Height</h3>
        <div class="value" id="blockHeight">-</div>
      </div>
      <div class="stat-card">
        <h3>Balance</h3>
        <div class="value" id="walletBalance">-</div>
      </div>
      <div class="stat-card">
        <h3>Mempool Size</h3>
        <div class="value" id="mempoolSize">-</div>
      </div>
      <div class="stat-card">
        <h3>Network</h3>
        <div class="value" id="networkName">regtest</div>
      </div>
    </div>

    <!-- Network Warning Banner -->
    <div class="network-warning" id="networkWarning">
      <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
      <span id="networkWarningText">Connected to mainnet. Mining and regtest-specific features are disabled.</span>
    </div>

    <div class="quick-actions">
      <button class="quick-action-btn regtest-only" id="mine1Btn" onclick="mineBlocks(1)">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Mine 1 Block
      </button>
      <button class="quick-action-btn regtest-only" id="mine10Btn" onclick="mineBlocks(10)">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Mine 10 Blocks
      </button>
      <button class="quick-action-btn regtest-only" id="mine100Btn" onclick="mineBlocks(100)">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Mine 100 Blocks
      </button>
      <button class="quick-action-btn" onclick="generateNewAddress()">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        New Address
      </button>
      <button class="quick-action-btn" onclick="refreshAll()">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        Refresh
      </button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="mining">Mining</button>
      <button class="tab" data-tab="wallet">Wallet</button>
      <button class="tab" data-tab="transactions">Transactions</button>
      <button class="tab" data-tab="mempool">Mempool</button>
      <button class="tab" data-tab="blocks">Blocks</button>
      <button class="tab" data-tab="explorer">Explorer</button>
      <button class="tab" data-tab="electrs">Electrs</button>
      <button class="tab" data-tab="raw">Raw TX</button>
      <button class="tab" data-tab="rpc">RPC Console</button>
    </div>

    <!-- Mining Tab -->
    <div class="tab-content active" id="tab-mining">
      <div class="grid-2">
        <div class="card regtest-only" id="mineBlocksCard">
          <h2>Mine Blocks</h2>
          <div class="inline-form">
            <div class="form-group">
              <label>Number of Blocks</label>
              <input type="number" id="mineBlockCount" value="1" min="1" max="1000">
            </div>
            <div class="form-group">
              <label>To Address (optional)</label>
              <input type="text" id="mineToAddress" placeholder="Leave empty for wallet address">
            </div>
            <button class="btn btn-primary" onclick="mineBlocksFromForm()">Mine</button>
          </div>
          <div id="mineResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="card">
          <h2>Mining Info</h2>
          <div id="miningInfo">
            <div class="empty-state">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Wallet Tab -->
    <div class="tab-content" id="tab-wallet">
      <div class="grid-2">
        <div class="card">
          <h2>Send Bitcoin</h2>
          <div class="form-group">
            <label>Recipient Address</label>
            <input type="text" id="sendAddress" placeholder="bcrt1...">
          </div>
          <div class="form-group">
            <label>Amount (BTC)</label>
            <input type="number" id="sendAmount" step="0.00000001" placeholder="0.1">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="sendReplaceable" checked>
            <label for="sendReplaceable">RBF Enabled (allows fee bumping)</label>
          </div>
          <button class="btn btn-primary" onclick="sendBitcoin()">Send</button>
          <div id="sendResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="card">
          <h2>Generate Address</h2>
          <div class="form-group">
            <label>Address Type</label>
            <select id="addressType">
              <option value="bech32">Bech32 (bc1...)</option>
              <option value="bech32m">Bech32m (Taproot)</option>
              <option value="p2sh-segwit">P2SH-SegWit (3...)</option>
              <option value="legacy">Legacy (1...)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Label (optional)</label>
            <input type="text" id="addressLabel" placeholder="My address">
          </div>
          <button class="btn btn-primary" onclick="generateAddress()">Generate</button>
          <div id="addressResult" class="result-box" style="display:none;"></div>
        </div>
      </div>

      <div class="card">
        <h2>Wallet Balance</h2>
        <div id="walletInfo">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <div class="card">
        <h2>UTXOs</h2>
        <div id="utxoList">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div class="tab-content" id="tab-transactions">
      <div class="card">
        <h2>RBF - Bump Fee</h2>
        <div class="inline-form">
          <div class="form-group" style="flex: 2;">
            <label>Transaction ID</label>
            <input type="text" id="bumpFeeTxid" placeholder="Enter txid of unconfirmed transaction">
          </div>
          <button class="btn btn-primary" onclick="bumpFee()">Bump Fee</button>
          <button class="btn btn-danger" onclick="cancelTransaction()">Cancel TX</button>
        </div>
        <div id="rbfResult" class="result-box" style="display:none;"></div>
      </div>

      <div class="card">
        <h2>Lookup Transaction</h2>
        <div class="inline-form">
          <div class="form-group" style="flex: 2;">
            <label>Transaction ID</label>
            <input type="text" id="lookupTxid" placeholder="Enter txid">
          </div>
          <button class="btn btn-primary" onclick="lookupTransaction()">Lookup</button>
        </div>
        <div id="txLookupResult" class="result-box" style="display:none;"></div>
      </div>

      <div class="card">
        <h2>Recent Transactions</h2>
        <div id="recentTransactions">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Mempool Tab -->
    <div class="tab-content" id="tab-mempool">
      <div class="card">
        <h2>Mempool Info</h2>
        <div id="mempoolInfo">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <div class="card">
        <h2>Mempool Transactions</h2>
        <button class="btn btn-secondary" onclick="loadMempoolTxs()" style="margin-bottom: 16px;">Refresh</button>
        <div id="mempoolTxs">
          <div class="empty-state">Click refresh to load</div>
        </div>
      </div>
    </div>

    <!-- Blocks Tab -->
    <div class="tab-content" id="tab-blocks">
      <div class="card">
        <h2>Block Lookup</h2>
        <div class="inline-form">
          <div class="form-group">
            <label>Block Height or Hash</label>
            <input type="text" id="blockLookup" placeholder="Enter height or hash">
          </div>
          <button class="btn btn-primary" onclick="lookupBlock()">Lookup</button>
        </div>
        <div id="blockLookupResult" class="result-box" style="display:none;"></div>
      </div>

      <div class="card">
        <h2>Recent Blocks</h2>
        <div id="recentBlocks">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Explorer Tab -->
    <div class="tab-content" id="tab-explorer">
      <div class="card">
        <h2>
          <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
            <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          Address & Transaction Explorer
        </h2>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          Search for any Bitcoin address or transaction ID to view detailed information.
        </p>
        <div class="inline-form">
          <div class="form-group" style="flex: 3;">
            <label>Address or Transaction ID</label>
            <input type="text" id="explorerSearch" placeholder="Enter address (bcrt1..., 1..., 3...) or txid">
          </div>
          <button class="btn btn-primary" onclick="explorerLookup()">
            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
              <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Search
          </button>
        </div>
      </div>

      <!-- Explorer Results -->
      <div id="explorerResults" style="display: none;">
        <!-- Address Results -->
        <div id="explorerAddressResults" style="display: none;">
          <div class="card">
            <h2>
              <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
              </svg>
              Address Details
            </h2>
            <div id="addressInfo">
              <div class="empty-state">Loading...</div>
            </div>
          </div>

          <div class="card">
            <h2>Address Transactions</h2>
            <div id="addressTransactions">
              <div class="empty-state">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Transaction Results -->
        <div id="explorerTxResults" style="display: none;">
          <div class="card">
            <h2>
              <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
              </svg>
              Transaction Details
            </h2>
            <div id="txSummary">
              <div class="empty-state">Loading...</div>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <h2>
                <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                  <path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/>
                </svg>
                Inputs (<span id="txInputCount">0</span>)
              </h2>
              <div id="txInputs">
                <div class="empty-state">Loading...</div>
              </div>
            </div>

            <div class="card">
              <h2>
                <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                  <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/>
                </svg>
                Outputs (<span id="txOutputCount">0</span>)
              </h2>
              <div id="txOutputs">
                <div class="empty-state">Loading...</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Raw Transaction Data</h2>
            <div id="txRawData" class="result-box" style="display: block; max-height: 300px;">
              Loading...
            </div>
          </div>
        </div>
      </div>

      <!-- Explorer Error -->
      <div id="explorerError" class="card" style="display: none;">
        <div id="explorerErrorMessage" class="result-box error"></div>
      </div>
    </div>

    <!-- Electrs Tab -->
    <div class="tab-content" id="tab-electrs">
      <div class="card">
        <h2>
          <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
            <path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6.01-4.69 7.29l1.06 1.77C19.69 19.47 22 15.99 22 12c0-4.97-3.63-9.09-8.39-9.87L13 2.05zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05C5.06 2.56 1 6.81 1 12c0 5.52 4.47 10 10 10 3.99 0 7.47-2.31 9.06-5.69l-1.77-1.06C16.99 17.48 14.64 19 12 19z"/>
            <path d="M11 7v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
          </svg>
          Electrs Server
        </h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Electrs is an efficient Electrum server implementation. Connect your Electrum wallet to query the blockchain without running a full node.
        </p>
        <div id="electrsInfo">
          <div class="empty-state">Loading connection info...</div>
        </div>
      </div>

      <div class="card">
        <h2>What is Electrs?</h2>
        <div style="color: var(--text-secondary); line-height: 1.8;">
          <p><strong>Electrs</strong> provides an Electrum server that indexes the Bitcoin blockchain and allows lightweight wallets to:</p>
          <ul style="margin: 16px 0; padding-left: 24px;">
            <li>Query address balances and transaction history</li>
            <li>Broadcast transactions to the network</li>
            <li>Subscribe to address notifications</li>
            <li>Get fee estimates</li>
          </ul>
          <p style="margin-top: 16px;">
            <strong>Port 50001</strong> is exposed for TCP connections using the Electrum protocol.
            Connect any Electrum-compatible wallet to interact with this regtest node.
          </p>
        </div>
      </div>

    </div>

    <!-- Raw TX Tab -->
    <div class="tab-content" id="tab-raw">
      <div class="grid-2">
        <div class="card">
          <h2>Decode Raw Transaction</h2>
          <div class="form-group">
            <label>Raw Transaction Hex</label>
            <textarea id="decodeRawTx" placeholder="Enter raw transaction hex..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="decodeRawTx()">Decode</button>
          <div id="decodeResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="card">
          <h2>Broadcast Raw Transaction</h2>
          <div class="form-group">
            <label>Signed Raw Transaction Hex</label>
            <textarea id="broadcastRawTx" placeholder="Enter signed raw transaction hex..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="broadcastRawTx()">Broadcast</button>
          <div id="broadcastResult" class="result-box" style="display:none;"></div>
        </div>
      </div>

      <div class="card">
        <h2>Test Mempool Accept</h2>
        <div class="form-group">
          <label>Raw Transaction Hex (to test without broadcasting)</label>
          <textarea id="testMempoolTx" placeholder="Enter raw transaction hex..."></textarea>
        </div>
        <button class="btn btn-secondary" onclick="testMempoolAccept()">Test Accept</button>
        <div id="testMempoolResult" class="result-box" style="display:none;"></div>
      </div>
    </div>

    <!-- RPC Console Tab -->
    <div class="tab-content" id="tab-rpc">
      <div class="card">
        <h2>RPC Console</h2>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">Execute any Bitcoin Core RPC command directly.</p>
        <div class="form-group">
          <label>RPC Method</label>
          <input type="text" id="rpcMethod" placeholder="e.g., getblockchaininfo">
        </div>
        <div class="form-group">
          <label>Parameters (JSON array, optional)</label>
          <textarea id="rpcParams" placeholder='e.g., ["bcrt1...", 0.1] or leave empty'></textarea>
        </div>
        <button class="btn btn-primary" onclick="executeRPC()">Execute</button>
        <div id="rpcResult" class="result-box" style="display:none;"></div>
      </div>

      <div class="card">
        <h2>Common RPC Commands</h2>
        <div class="btn-group" style="flex-wrap: wrap;">
          <button class="btn btn-secondary" onclick="quickRPC('getblockchaininfo')">getblockchaininfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('getnetworkinfo')">getnetworkinfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('getmininginfo')">getmininginfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('getmempoolinfo')">getmempoolinfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('getwalletinfo')">getwalletinfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('listwallets')">listwallets</button>
          <button class="btn btn-secondary" onclick="quickRPC('getpeerinfo')">getpeerinfo</button>
          <button class="btn btn-secondary" onclick="quickRPC('uptime')">uptime</button>
        </div>
      </div>

      <div class="card regtest-only" id="dangerZoneCard" style="border-color: var(--accent-red);">
        <h2 style="color: var(--accent-red);">Danger Zone</h2>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          These actions are destructive and cannot be easily undone. Use with caution.
        </p>

        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start;">
          <div style="flex: 1; min-width: 250px;">
            <h4 style="margin-bottom: 8px; font-size: 0.95rem;">Reset Chain</h4>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 12px;">
              Invalidate all blocks and reset to genesis (block 0). Your wallet balance will be lost.
            </p>
            <button class="btn btn-danger" onclick="showResetConfirm()">Reset Chain to Genesis</button>
          </div>

          <div style="flex: 1; min-width: 250px;">
            <h4 style="margin-bottom: 8px; font-size: 0.95rem;">Restore Chain</h4>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 12px;">
              Reconsider invalidated blocks and restore the chain to its previous state.
            </p>
            <button class="btn btn-secondary" onclick="reconsiderChain()">Restore Invalidated Blocks</button>
          </div>
        </div>

        <div id="resetResult" class="result-box" style="display:none; margin-top: 16px;"></div>
      </div>
    </div>
  </div>

  <!-- Reset Confirmation Modal -->
  <div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-secondary); border: 1px solid var(--accent-red); border-radius: 12px; padding: 24px; max-width: 450px; margin: 20px;">
      <h3 style="color: var(--accent-red); margin-bottom: 16px;">Confirm Chain Reset</h3>
      <p style="color: var(--text-secondary); margin-bottom: 16px;">
        This will invalidate ALL blocks and reset the chain to block 0.
        <strong style="color: var(--text-primary);">Your entire wallet balance will be lost.</strong>
      </p>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Type <strong style="color: var(--accent-red);">RESET</strong> below to confirm:
      </p>
      <input type="text" id="resetConfirmInput" placeholder="Type RESET to confirm" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); margin-bottom: 20px; font-size: 1rem;">
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="hideResetModal()" style="flex: 1;">Cancel</button>
        <button class="btn btn-danger" onclick="executeReset()" style="flex: 1;">Reset Chain</button>
      </div>
    </div>
  </div>

  <script src="qrcode.min.js"></script>
  <script>
    const API_BASE = '/api';
    let currentNetwork = 'unknown';

    // Update UI based on network type
    function updateNetworkUI(chain) {
      currentNetwork = chain;
      const isRegtest = chain === 'regtest';
      const regtestElements = document.querySelectorAll('.regtest-only');
      const warningBanner = document.getElementById('networkWarning');
      const warningText = document.getElementById('networkWarningText');

      regtestElements.forEach(el => {
        if (isRegtest) {
          el.classList.remove('disabled');
        } else {
          el.classList.add('disabled');
        }
      });

      if (isRegtest) {
        warningBanner.classList.remove('visible');
      } else {
        const networkName = chain.charAt(0).toUpperCase() + chain.slice(1);
        warningText.textContent = `Connected to ${networkName}. Mining and regtest-specific features are disabled.`;
        warningBanner.classList.add('visible');
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // API helper
    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(API_BASE + endpoint, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Request failed');
        return data;
      } catch (error) {
        throw error;
      }
    }

    // Display result in a box
    function showResult(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      el.className = 'result-box ' + (isError ? 'error' : 'success');
      el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    // Update connection status
    async function checkConnection() {
      try {
        const health = await api('/health');
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('statusText').textContent = `Connected (${health.chain})`;
        return true;
      } catch (error) {
        document.getElementById('statusDot').classList.remove('connected');
        document.getElementById('statusText').textContent = 'Disconnected';
        return false;
      }
    }

    // Check Electrs connection status
    async function checkElectrsConnection() {
      try {
        const health = await api('/electrs/health');
        document.getElementById('electrsStatusDot').classList.add('connected');
        document.getElementById('electrsStatusText').textContent = 'Electrs On';
        return true;
      } catch (error) {
        document.getElementById('electrsStatusDot').classList.remove('connected');
        document.getElementById('electrsStatusText').textContent = 'Electrs Off';
        return false;
      }
    }

    // Load Electrs connection info
    async function loadElectrsInfo() {
      try {
        const info = await api('/electrs/info');
        const electrsInfoEl = document.getElementById('electrsInfo');
        if (electrsInfoEl) {
          // Connection string in Umbrel format: host:port:t (TCP) or host:port:s (SSL)
          const protocolSuffix = info.protocol === 'ssl' ? 's' : 't';
          const connectionString = `${info.host}:${info.port}:${protocolSuffix}`;

          electrsInfoEl.innerHTML = `
            <div class="stats-grid" style="margin: 0;">
              <div class="stat-card">
                <h3>Status</h3>
                <div class="value">
                  <span class="badge ${info.connected ? 'badge-success' : 'badge-danger'}">
                    ${info.connected ? 'Connected' : 'Disconnected'}
                  </span>
                </div>
              </div>
              <div class="stat-card">
                <h3>Host</h3>
                <div class="value" style="font-size: 1rem;">${info.host}:${info.port}</div>
              </div>
              <div class="stat-card">
                <h3>Protocol</h3>
                <div class="value" style="font-size: 1rem;">${info.protocol.toUpperCase()}</div>
              </div>
              <div class="stat-card">
                <h3>Network</h3>
                <div class="value" style="font-size: 1rem;">${info.network}</div>
              </div>
            </div>
            <div style="margin-top: 16px; padding: 16px; background: var(--bg-primary); border-radius: 8px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
              <div id="electrsQrCode" style="background: white; padding: 8px; border-radius: 8px; display: inline-block;"></div>
              <div style="flex: 1; min-width: 200px;">
                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px;">Connection String (Umbrel format):</div>
                <code style="font-size: 1rem; word-break: break-all; display: block; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                  ${connectionString}
                </code>
                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px; margin-bottom: 8px;">Connect with Electrum CLI:</div>
                <code style="font-size: 0.85rem; word-break: break-all; display: block; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                  electrum --regtest --oneserver --server ${connectionString}
                </code>
              </div>
            </div>
          `;

          // Generate QR code
          const qr = qrcode(0, 'M');
          qr.addData(connectionString);
          qr.make();
          document.getElementById('electrsQrCode').innerHTML = qr.createSvgTag(4);
        }
      } catch (error) {
        console.error('Failed to load electrs info:', error);
      }
    }

    // Refresh stats
    async function refreshStats() {
      try {
        const [blockchain, balance, mempool] = await Promise.all([
          api('/blockchain/info'),
          api('/wallet/balance').catch(() => ({ confirmed: 0 })),
          api('/mempool/info')
        ]);

        document.getElementById('blockHeight').textContent = blockchain.blocks.toLocaleString();
        // Format balance: show fewer decimals for large amounts
        const bal = balance.confirmed;
        let balanceText;
        if (bal >= 1000) {
          balanceText = bal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' BTC';
        } else if (bal >= 1) {
          balanceText = bal.toFixed(4) + ' BTC';
        } else {
          balanceText = bal.toFixed(8) + ' BTC';
        }
        document.getElementById('walletBalance').textContent = balanceText;
        document.getElementById('mempoolSize').textContent = mempool.size;
        document.getElementById('networkName').textContent = blockchain.chain;

        // Update UI based on network type
        updateNetworkUI(blockchain.chain);
      } catch (error) {
        console.error('Failed to refresh stats:', error);
      }
    }

    // Mine blocks
    async function mineBlocks(count, address = null) {
      try {
        const result = await api('/mine', {
          method: 'POST',
          body: JSON.stringify({ blocks: count, address: address })
        });
        showResult('mineResult', result);
        refreshStats();
        loadMiningInfo();
        loadRecentBlocks();
        loadRecentTransactions();
        loadUTXOs();
        return result;
      } catch (error) {
        showResult('mineResult', error.message, true);
      }
    }

    function mineBlocksFromForm() {
      const count = document.getElementById('mineBlockCount').value;
      const address = document.getElementById('mineToAddress').value || null;
      mineBlocks(parseInt(count), address);
    }

    // Generate new address
    // Copy to clipboard helper (works on HTTP)
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
      } catch (e) {
        console.log('Copy failed:', e);
      }
      document.body.removeChild(textArea);
    }

    async function generateNewAddress() {
      try {
        const result = await api('/wallet/newaddress', {
          method: 'POST',
          body: JSON.stringify({ addressType: 'bech32' })
        });
        copyToClipboard(result.address);
        alert('New Address (copied to clipboard):\n\n' + result.address);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function generateAddress() {
      try {
        const addressType = document.getElementById('addressType').value;
        const label = document.getElementById('addressLabel').value;
        const result = await api('/wallet/newaddress', {
          method: 'POST',
          body: JSON.stringify({ addressType, label })
        });
        showResult('addressResult', result);
      } catch (error) {
        showResult('addressResult', error.message, true);
      }
    }

    // Send Bitcoin
    async function sendBitcoin() {
      try {
        const address = document.getElementById('sendAddress').value;
        const amount = document.getElementById('sendAmount').value;
        const replaceable = document.getElementById('sendReplaceable').checked;

        if (!address || !amount) {
          showResult('sendResult', 'Please enter address and amount', true);
          return;
        }

        const result = await api('/wallet/send', {
          method: 'POST',
          body: JSON.stringify({ address, amount: parseFloat(amount), replaceable })
        });
        showResult('sendResult', result);
        refreshStats();
        loadRecentTransactions();
        loadUTXOs();
        loadMempoolInfo();
      } catch (error) {
        showResult('sendResult', error.message, true);
      }
    }

    // RBF - Bump fee
    async function bumpFee() {
      try {
        const txid = document.getElementById('bumpFeeTxid').value;
        if (!txid) {
          showResult('rbfResult', 'Please enter a transaction ID', true);
          return;
        }
        const result = await api('/transaction/bumpfee', {
          method: 'POST',
          body: JSON.stringify({ txid })
        });
        showResult('rbfResult', result);
      } catch (error) {
        showResult('rbfResult', error.message, true);
      }
    }

    // Cancel transaction
    async function cancelTransaction() {
      try {
        const txid = document.getElementById('bumpFeeTxid').value;
        if (!txid) {
          showResult('rbfResult', 'Please enter a transaction ID', true);
          return;
        }
        const result = await api('/transaction/cancel', {
          method: 'POST',
          body: JSON.stringify({ txid })
        });
        showResult('rbfResult', result);
      } catch (error) {
        showResult('rbfResult', error.message, true);
      }
    }

    // Lookup transaction
    async function lookupTransaction() {
      try {
        const txid = document.getElementById('lookupTxid').value;
        if (!txid) {
          showResult('txLookupResult', 'Please enter a transaction ID', true);
          return;
        }
        const result = await api('/transaction/' + txid);
        showResult('txLookupResult', result);
      } catch (error) {
        showResult('txLookupResult', error.message, true);
      }
    }

    // Load recent transactions
    async function loadRecentTransactions() {
      try {
        const transactions = await api('/wallet/transactions?count=20');
        const container = document.getElementById('recentTransactions');

        if (!transactions.length) {
          container.innerHTML = '<div class="empty-state">No transactions yet</div>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>TXID</th>
                <th>Amount</th>
                <th>Confirmations</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody>
              ${transactions.reverse().map(tx => `
                <tr>
                  <td class="truncate" title="${tx.txid}">${tx.txid}</td>
                  <td>${tx.amount > 0 ? '+' : ''}${tx.amount.toFixed(8)} BTC</td>
                  <td>${tx.confirmations}</td>
                  <td><span class="badge ${tx.category === 'receive' ? 'badge-success' : 'badge-warning'}">${tx.category}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        document.getElementById('recentTransactions').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Load UTXOs
    async function loadUTXOs() {
      try {
        const utxos = await api('/wallet/utxos');
        const container = document.getElementById('utxoList');

        if (!utxos.length) {
          container.innerHTML = '<div class="empty-state">No UTXOs available</div>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>TXID:Vout</th>
                <th>Amount</th>
                <th>Confirmations</th>
                <th>Address</th>
              </tr>
            </thead>
            <tbody>
              ${utxos.map(utxo => `
                <tr>
                  <td class="truncate" title="${utxo.txid}:${utxo.vout}">${utxo.txid.substring(0, 16)}...:${utxo.vout}</td>
                  <td>${utxo.amount.toFixed(8)} BTC</td>
                  <td>${utxo.confirmations}</td>
                  <td class="truncate" title="${utxo.address}">${utxo.address}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        document.getElementById('utxoList').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Load wallet info
    async function loadWalletInfo() {
      try {
        const [balance, info] = await Promise.all([
          api('/wallet/balance'),
          api('/wallet/info').catch(() => null)
        ]);

        document.getElementById('walletInfo').innerHTML = `
          <div class="stats-grid" style="margin: 0;">
            <div class="stat-card">
              <h3>Confirmed</h3>
              <div class="value">${balance.confirmed.toFixed(8)}</div>
            </div>
            <div class="stat-card">
              <h3>Unconfirmed</h3>
              <div class="value">${balance.unconfirmed.toFixed(8)}</div>
            </div>
            ${info ? `
              <div class="stat-card">
                <h3>TX Count</h3>
                <div class="value">${info.txcount || 0}</div>
              </div>
            ` : ''}
          </div>
        `;
      } catch (error) {
        document.getElementById('walletInfo').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Load mempool info
    async function loadMempoolInfo() {
      try {
        const info = await api('/mempool/info');
        document.getElementById('mempoolInfo').innerHTML = `
          <div class="stats-grid" style="margin: 0;">
            <div class="stat-card">
              <h3>Size</h3>
              <div class="value">${info.size}</div>
            </div>
            <div class="stat-card">
              <h3>Bytes</h3>
              <div class="value">${(info.bytes / 1024).toFixed(2)} KB</div>
            </div>
            <div class="stat-card">
              <h3>Max Mempool</h3>
              <div class="value">${(info.maxmempool / 1024 / 1024).toFixed(0)} MB</div>
            </div>
            <div class="stat-card">
              <h3>Min Fee</h3>
              <div class="value">${info.mempoolminfee}</div>
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById('mempoolInfo').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Load mempool transactions
    async function loadMempoolTxs() {
      try {
        const txs = await api('/mempool/raw?verbose=true');
        const container = document.getElementById('mempoolTxs');
        const txids = Object.keys(txs);

        if (!txids.length) {
          container.innerHTML = '<div class="empty-state">Mempool is empty</div>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>TXID</th>
                <th>Size</th>
                <th>Fee</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              ${txids.slice(0, 50).map(txid => {
                const tx = txs[txid];
                return `
                  <tr>
                    <td class="truncate" title="${txid}">${txid}</td>
                    <td>${tx.vsize} vB</td>
                    <td>${(tx.fees.base * 100000000).toFixed(0)} sat</td>
                    <td>${new Date(tx.time * 1000).toLocaleTimeString()}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          ${txids.length > 50 ? `<p style="color: var(--text-secondary); margin-top: 16px;">Showing 50 of ${txids.length} transactions</p>` : ''}
        `;
      } catch (error) {
        document.getElementById('mempoolTxs').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Lookup block
    async function lookupBlock() {
      try {
        const input = document.getElementById('blockLookup').value;
        if (!input) {
          showResult('blockLookupResult', 'Please enter a block height or hash', true);
          return;
        }

        let result;
        if (/^\d+$/.test(input)) {
          result = await api('/block/height/' + input);
        } else {
          result = await api('/block/' + input);
        }
        showResult('blockLookupResult', result);
      } catch (error) {
        showResult('blockLookupResult', error.message, true);
      }
    }

    // Load recent blocks
    async function loadRecentBlocks() {
      try {
        const blockchain = await api('/blockchain/info');
        const blocks = [];

        for (let i = blockchain.blocks; i >= Math.max(0, blockchain.blocks - 9); i--) {
          try {
            const block = await api('/block/height/' + i);
            blocks.push(block);
          } catch (e) {
            break;
          }
        }

        const container = document.getElementById('recentBlocks');
        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Height</th>
                <th>Hash</th>
                <th>TXs</th>
                <th>Size</th>
              </tr>
            </thead>
            <tbody>
              ${blocks.map(block => `
                <tr>
                  <td>${block.height}</td>
                  <td class="truncate" title="${block.hash}">${block.hash}</td>
                  <td>${block.nTx}</td>
                  <td>${(block.size / 1024).toFixed(2)} KB</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        document.getElementById('recentBlocks').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Load mining info
    // Format difficulty for display
    function formatDifficulty(diff) {
      if (diff < 0.0001) {
        return diff.toExponential(2);
      } else if (diff < 1) {
        return diff.toFixed(8);
      } else if (diff < 1000) {
        return diff.toFixed(2);
      } else if (diff < 1000000) {
        return (diff / 1000).toFixed(2) + ' K';
      } else if (diff < 1000000000) {
        return (diff / 1000000).toFixed(2) + ' M';
      } else if (diff < 1000000000000) {
        return (diff / 1000000000).toFixed(2) + ' B';
      } else {
        return (diff / 1000000000000).toFixed(2) + ' T';
      }
    }

    // Format hashrate with appropriate unit
    function formatHashrate(hashps) {
      if (hashps === 0) return '0 H/s';

      const units = ['H/s', 'KH/s', 'MH/s', 'GH/s', 'TH/s', 'PH/s', 'EH/s', 'ZH/s'];
      let unitIndex = 0;
      let value = hashps;

      while (value >= 1000 && unitIndex < units.length - 1) {
        value /= 1000;
        unitIndex++;
      }

      // For very small values (like regtest), show more precision
      if (value < 0.01) {
        return value.toExponential(2) + ' ' + units[unitIndex];
      } else if (value < 10) {
        return value.toFixed(3) + ' ' + units[unitIndex];
      } else if (value < 100) {
        return value.toFixed(2) + ' ' + units[unitIndex];
      } else {
        return value.toFixed(1) + ' ' + units[unitIndex];
      }
    }

    async function loadMiningInfo() {
      try {
        const info = await api('/mining/info');
        document.getElementById('miningInfo').innerHTML = `
          <div class="stats-grid" style="margin: 0;">
            <div class="stat-card">
              <h3>Blocks</h3>
              <div class="value">${info.blocks}</div>
            </div>
            <div class="stat-card">
              <h3>Difficulty</h3>
              <div class="value" title="${info.difficulty}">${formatDifficulty(info.difficulty)}</div>
            </div>
            <div class="stat-card">
              <h3>Hashrate</h3>
              <div class="value" title="${info.networkhashps} H/s">${formatHashrate(info.networkhashps)}</div>
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById('miningInfo').innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
      }
    }

    // Decode raw transaction
    async function decodeRawTx() {
      try {
        const hex = document.getElementById('decodeRawTx').value;
        if (!hex) {
          showResult('decodeResult', 'Please enter raw transaction hex', true);
          return;
        }
        const result = await api('/transaction/decode', {
          method: 'POST',
          body: JSON.stringify({ hex })
        });
        showResult('decodeResult', result);
      } catch (error) {
        showResult('decodeResult', error.message, true);
      }
    }

    // Broadcast raw transaction
    async function broadcastRawTx() {
      try {
        const hex = document.getElementById('broadcastRawTx').value;
        if (!hex) {
          showResult('broadcastResult', 'Please enter raw transaction hex', true);
          return;
        }
        const result = await api('/transaction/send', {
          method: 'POST',
          body: JSON.stringify({ hex })
        });
        showResult('broadcastResult', result);
        refreshStats();
      } catch (error) {
        showResult('broadcastResult', error.message, true);
      }
    }

    // Test mempool accept
    async function testMempoolAccept() {
      try {
        const hex = document.getElementById('testMempoolTx').value;
        if (!hex) {
          showResult('testMempoolResult', 'Please enter raw transaction hex', true);
          return;
        }
        const result = await api('/transaction/testmempoolaccept', {
          method: 'POST',
          body: JSON.stringify({ rawtxs: [hex] })
        });
        showResult('testMempoolResult', result);
      } catch (error) {
        showResult('testMempoolResult', error.message, true);
      }
    }

    // RPC Console
    async function executeRPC() {
      try {
        const method = document.getElementById('rpcMethod').value;
        if (!method) {
          showResult('rpcResult', 'Please enter an RPC method', true);
          return;
        }

        let params = [];
        const paramsStr = document.getElementById('rpcParams').value.trim();
        if (paramsStr) {
          try {
            params = JSON.parse(paramsStr);
          } catch (e) {
            showResult('rpcResult', 'Invalid JSON in parameters', true);
            return;
          }
        }

        const result = await api('/rpc', {
          method: 'POST',
          body: JSON.stringify({ method, params })
        });
        showResult('rpcResult', result);
      } catch (error) {
        showResult('rpcResult', error.message, true);
      }
    }

    async function quickRPC(method) {
      document.getElementById('rpcMethod').value = method;
      document.getElementById('rpcParams').value = '';
      await executeRPC();
    }

    // Explorer Functions
    function isTransactionId(input) {
      // Transaction IDs are 64 hex characters
      return /^[a-fA-F0-9]{64}$/.test(input);
    }

    function isAddress(input) {
      // Bitcoin address patterns (mainnet, testnet, regtest)
      // bech32/bech32m: bc1, tb1, bcrt1
      // P2SH: starts with 3 (mainnet), 2 (testnet/regtest)
      // Legacy: starts with 1 (mainnet), m/n (testnet/regtest)
      return /^(bc1|tb1|bcrt1|[123mn])[a-zA-HJ-NP-Z0-9]{25,62}$/i.test(input);
    }

    async function explorerLookup() {
      const input = document.getElementById('explorerSearch').value.trim();

      if (!input) {
        showExplorerError('Please enter an address or transaction ID');
        return;
      }

      // Hide previous results
      document.getElementById('explorerResults').style.display = 'none';
      document.getElementById('explorerAddressResults').style.display = 'none';
      document.getElementById('explorerTxResults').style.display = 'none';
      document.getElementById('explorerError').style.display = 'none';

      if (isTransactionId(input)) {
        await explorerLookupTransaction(input);
      } else if (isAddress(input)) {
        await explorerLookupAddress(input);
      } else {
        // Try transaction first, then address
        try {
          await explorerLookupTransaction(input);
        } catch (e) {
          try {
            await explorerLookupAddress(input);
          } catch (e2) {
            showExplorerError('Invalid input. Please enter a valid Bitcoin address or transaction ID.');
          }
        }
      }
    }

    function showExplorerError(message) {
      document.getElementById('explorerResults').style.display = 'none';
      document.getElementById('explorerError').style.display = 'block';
      document.getElementById('explorerErrorMessage').textContent = message;
    }

    async function explorerLookupTransaction(txid) {
      try {
        // First try to get wallet transaction info for confirmations
        let walletTx = null;
        try {
          walletTx = await api('/transaction/' + txid);
        } catch (e) {
          // Transaction might not be in wallet, that's okay
        }

        // Get the decoded transaction using getrawtransaction for full vin/vout details
        const rawResponse = await api('/transaction/' + txid + '/raw?verbose=true');
        const tx = rawResponse.raw;

        if (!tx || typeof tx === 'string') {
          // If verbose=true didn't work, we got hex string - need to decode it
          throw new Error('Could not decode transaction');
        }

        document.getElementById('explorerResults').style.display = 'block';
        document.getElementById('explorerAddressResults').style.display = 'none';
        document.getElementById('explorerTxResults').style.display = 'block';
        document.getElementById('explorerError').style.display = 'none';

        // Calculate total input/output values
        let totalOutput = 0;
        if (tx.vout) {
          tx.vout.forEach(out => { totalOutput += out.value; });
        }

        // Transaction summary - use wallet tx for confirmations if available
        const confirmations = walletTx?.confirmations ?? tx.confirmations ?? 0;
        const statusBadge = confirmations > 0
          ? `<span class="badge badge-success">${confirmations} confirmations</span>`
          : '<span class="badge badge-warning">Unconfirmed</span>';

        // Get block info from either source
        const blockhash = tx.blockhash || walletTx?.blockhash;
        const blocktime = tx.blocktime || walletTx?.blocktime || walletTx?.time;

        document.getElementById('txSummary').innerHTML = `
          <div class="stats-grid" style="margin: 0;">
            <div class="stat-card">
              <h3>Transaction ID</h3>
              <div class="value wrap-ok" style="font-size: 0.85rem; word-break: break-all;">
                ${tx.txid}
                <button class="copy-btn" onclick="copyToClipboard('${tx.txid}')" style="margin-left: 8px;">Copy</button>
              </div>
            </div>
            <div class="stat-card">
              <h3>Status</h3>
              <div class="value">${statusBadge}</div>
            </div>
            <div class="stat-card">
              <h3>Size</h3>
              <div class="value">${tx.size || 'N/A'} B / ${tx.vsize || 'N/A'} vB</div>
            </div>
            <div class="stat-card">
              <h3>Total Output</h3>
              <div class="value">${totalOutput.toFixed(8)} BTC</div>
            </div>
            ${blockhash ? `
              <div class="stat-card">
                <h3>Block Hash</h3>
                <div class="value wrap-ok" style="font-size: 0.75rem; word-break: break-all;">${blockhash}</div>
              </div>
            ` : ''}
            ${blocktime ? `
              <div class="stat-card">
                <h3>Block Time</h3>
                <div class="value" style="font-size: 0.9rem;">${new Date(blocktime * 1000).toLocaleString()}</div>
              </div>
            ` : ''}
          </div>
        `;

        // Update input/output counts
        const vinArray = tx.vin || [];
        const voutArray = tx.vout || [];
        document.getElementById('txInputCount').textContent = vinArray.length;
        document.getElementById('txOutputCount').textContent = voutArray.length;

        // Render inputs
        if (vinArray.length === 0 || (vinArray.length === 1 && vinArray[0].coinbase)) {
          document.getElementById('txInputs').innerHTML = `
            <div style="padding: 16px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <span class="badge badge-success" style="font-size: 0.9rem;">Coinbase (Mining Reward)</span>
            </div>
          `;
        } else {
          document.getElementById('txInputs').innerHTML = `
            <div style="max-height: 400px; overflow-y: auto;">
              ${vinArray.map((input, idx) => `
                <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: var(--text-secondary); font-size: 0.85rem;">#${idx}</span>
                    ${input.prevout && input.prevout.value ? `
                      <span style="color: var(--accent-orange); font-weight: 600;">${input.prevout.value.toFixed(8)} BTC</span>
                    ` : ''}
                  </div>
                  <div style="font-family: monospace; font-size: 0.8rem; word-break: break-all; color: var(--text-secondary);">
                    ${input.txid ? `${input.txid}:${input.vout}` : 'N/A'}
                  </div>
                  ${input.prevout && input.prevout.scriptPubKey && input.prevout.scriptPubKey.address ? `
                    <div style="margin-top: 8px;">
                      <a href="#" onclick="explorerSearchAddress('${input.prevout.scriptPubKey.address}'); return false;"
                         style="color: var(--accent-blue); font-family: monospace; font-size: 0.85rem; text-decoration: none;">
                        ${input.prevout.scriptPubKey.address}
                      </a>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          `;
        }

        // Render outputs
        document.getElementById('txOutputs').innerHTML = `
          <div style="max-height: 400px; overflow-y: auto;">
            ${voutArray.map((output, idx) => `
              <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="color: var(--text-secondary); font-size: 0.85rem;">#${idx}</span>
                  <span style="color: var(--accent-green); font-weight: 600;">${output.value.toFixed(8)} BTC</span>
                </div>
                ${output.scriptPubKey.address ? `
                  <div>
                    <a href="#" onclick="explorerSearchAddress('${output.scriptPubKey.address}'); return false;"
                       style="color: var(--accent-blue); font-family: monospace; font-size: 0.85rem; text-decoration: none;">
                      ${output.scriptPubKey.address}
                    </a>
                  </div>
                ` : `
                  <div style="color: var(--text-secondary); font-size: 0.85rem;">
                    ${output.scriptPubKey.type || 'Unknown type'}
                  </div>
                `}
                <div style="margin-top: 4px; color: var(--text-secondary); font-size: 0.75rem;">
                  Type: ${output.scriptPubKey.type || 'unknown'}
                </div>
              </div>
            `).join('')}
          </div>
        `;

        // Raw transaction data
        document.getElementById('txRawData').textContent = JSON.stringify(tx, null, 2);

      } catch (error) {
        showExplorerError('Transaction not found: ' + error.message);
        throw error;
      }
    }

    async function explorerLookupAddress(address) {
      try {
        // First validate the address
        const validation = await api('/validateaddress/' + address);

        if (!validation.isvalid) {
          showExplorerError('Invalid Bitcoin address');
          return;
        }

        document.getElementById('explorerResults').style.display = 'block';
        document.getElementById('explorerAddressResults').style.display = 'block';
        document.getElementById('explorerTxResults').style.display = 'none';
        document.getElementById('explorerError').style.display = 'none';

        // Try to get wallet info (may fail if address is not in wallet)
        let addressInfo = null;
        try {
          addressInfo = await api('/wallet/addressinfo/' + address);
        } catch (e) {
          // Address not in wallet, that's okay
        }

        // Try Electrs first for comprehensive address data (works for ANY address)
        let electrsData = null;
        let electrsTxs = [];
        let electrsUtxos = [];
        let balance = null;
        let txCount = 0;

        try {
          electrsData = await api('/electrs/address/' + address);
          electrsTxs = await api('/electrs/address/' + address + '/txs');
          electrsUtxos = await api('/electrs/address/' + address + '/utxo');

          // Calculate balance from electrs data (values in satoshis)
          const funded = electrsData.chain_stats?.funded_txo_sum || 0;
          const spent = electrsData.chain_stats?.spent_txo_sum || 0;
          const mempoolFunded = electrsData.mempool_stats?.funded_txo_sum || 0;
          const mempoolSpent = electrsData.mempool_stats?.spent_txo_sum || 0;

          balance = {
            received: (funded + mempoolFunded) / 100000000,
            sent: (spent + mempoolSpent) / 100000000,
            balance: (funded - spent + mempoolFunded - mempoolSpent) / 100000000
          };
          txCount = (electrsData.chain_stats?.tx_count || 0) + (electrsData.mempool_stats?.tx_count || 0);
        } catch (e) {
          // Electrs not available, fall back to wallet-based lookup
          console.log('Electrs lookup failed, falling back to wallet:', e.message);

          // Get wallet transactions and filter by address
          try {
            const allTxs = await api('/wallet/transactions?count=100');
            const addressTxs = allTxs.filter(tx => tx.address === address);

            let received = 0;
            let sent = 0;
            addressTxs.forEach(tx => {
              if (tx.category === 'receive' || tx.category === 'generate' || tx.category === 'immature') {
                received += Math.abs(tx.amount);
              } else if (tx.category === 'send') {
                sent += Math.abs(tx.amount);
              }
            });
            balance = { received, sent, balance: received - sent };
            txCount = addressTxs.length;
            electrsTxs = addressTxs; // Use wallet txs for display
          } catch (e2) {
            // No wallet transactions either
          }
        }

        // Build address info display
        const isWalletAddress = addressInfo && addressInfo.ismine;
        const dataSource = electrsData ? 'Electrs' : 'Wallet';

        document.getElementById('addressInfo').innerHTML = `
          <div class="stats-grid" style="margin: 0;">
            <div class="stat-card">
              <h3>Address</h3>
              <div class="value wrap-ok" style="font-size: 0.85rem; word-break: break-all;">
                ${address}
                <button class="copy-btn" onclick="copyToClipboard('${address}')" style="margin-left: 8px;">Copy</button>
              </div>
            </div>
            <div class="stat-card">
              <h3>Type</h3>
              <div class="value" style="font-size: 1rem;">
                ${validation.address_type || (address.startsWith('bcrt1p') || address.startsWith('bc1p') || address.startsWith('tb1p') ? 'witness_v1_taproot' :
                  address.startsWith('bcrt1') || address.startsWith('bc1') || address.startsWith('tb1') ? 'witness_v0_keyhash' :
                  address.startsWith('3') || address.startsWith('2') ? 'scripthash' : 'pubkeyhash')}
              </div>
            </div>
            <div class="stat-card">
              <h3>Wallet Status</h3>
              <div class="value">
                ${isWalletAddress
                  ? '<span class="badge badge-success">In Wallet</span>'
                  : '<span class="badge badge-warning">External</span>'}
              </div>
            </div>
            <div class="stat-card">
              <h3>Data Source</h3>
              <div class="value" style="font-size: 1rem;">
                <span class="badge ${electrsData ? 'badge-success' : 'badge-warning'}">${dataSource}</span>
              </div>
            </div>
            ${balance ? `
              <div class="stat-card">
                <h3>Total Received</h3>
                <div class="value" style="color: var(--accent-green);">${balance.received.toFixed(8)} BTC</div>
              </div>
              <div class="stat-card">
                <h3>Total Sent</h3>
                <div class="value" style="color: var(--accent-red);">${balance.sent.toFixed(8)} BTC</div>
              </div>
              <div class="stat-card">
                <h3>Balance</h3>
                <div class="value">${balance.balance.toFixed(8)} BTC</div>
              </div>
            ` : ''}
            <div class="stat-card">
              <h3>Transactions</h3>
              <div class="value">${txCount}</div>
            </div>
            ${electrsUtxos.length > 0 ? `
              <div class="stat-card">
                <h3>UTXOs</h3>
                <div class="value">${electrsUtxos.length}</div>
              </div>
            ` : ''}
            ${addressInfo && addressInfo.labels && addressInfo.labels.length > 0 ? `
              <div class="stat-card">
                <h3>Label</h3>
                <div class="value" style="font-size: 1rem;">${addressInfo.labels.join(', ')}</div>
              </div>
            ` : ''}
          </div>
          ${addressInfo && addressInfo.hdkeypath ? `
            <div style="margin-top: 16px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">HD Key Path</div>
              <div style="font-family: monospace; font-size: 0.9rem;">${addressInfo.hdkeypath}</div>
            </div>
          ` : ''}
          ${validation.scriptPubKey ? `
            <div style="margin-top: 16px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 4px;">Script PubKey</div>
              <div style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">${validation.scriptPubKey}</div>
            </div>
          ` : ''}
          ${electrsUtxos.length > 0 ? `
            <div style="margin-top: 16px;">
              <h3 style="margin-bottom: 12px; color: var(--text-secondary);">UTXOs (${electrsUtxos.length})</h3>
              <div style="max-height: 200px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>Txid</th>
                      <th>Vout</th>
                      <th>Value (BTC)</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${electrsUtxos.map(utxo => `
                      <tr>
                        <td class="truncate" style="max-width: 150px;" title="${utxo.txid}">${utxo.txid}</td>
                        <td>${utxo.vout}</td>
                        <td>${(utxo.value / 100000000).toFixed(8)}</td>
                        <td>${utxo.status?.confirmed ? '<span class="badge badge-success">Confirmed</span>' : '<span class="badge badge-warning">Unconfirmed</span>'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : ''}
        `;

        // Address transactions - handle both electrs and wallet formats
        if (electrsTxs.length > 0) {
          // Check if we have electrs data (has 'txid' at root) or wallet data (has 'category')
          const isElectrsFormat = electrsTxs[0] && !electrsTxs[0].category;

          if (isElectrsFormat) {
            // Electrs transaction format
            document.getElementById('addressTransactions').innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>TXID</th>
                    <th>Status</th>
                    <th>Block Height</th>
                    <th>Fee (sats)</th>
                  </tr>
                </thead>
                <tbody>
                  ${electrsTxs.slice(0, 50).map(tx => `
                    <tr style="cursor: pointer;" onclick="explorerSearchTxid('${tx.txid}')">
                      <td class="truncate" title="${tx.txid}" style="max-width: 200px;">${tx.txid}</td>
                      <td>
                        <span class="badge ${tx.status?.confirmed ? 'badge-success' : 'badge-warning'}">
                          ${tx.status?.confirmed ? 'Confirmed' : 'Unconfirmed'}
                        </span>
                      </td>
                      <td>${tx.status?.block_height || 'Pending'}</td>
                      <td>${tx.fee || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              ${electrsTxs.length > 50 ? `<div style="text-align: center; padding: 12px; color: var(--text-secondary);">Showing first 50 of ${electrsTxs.length} transactions</div>` : ''}
            `;
          } else {
            // Wallet transaction format
            document.getElementById('addressTransactions').innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>TXID</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Confirmations</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
                  ${electrsTxs.map(tx => `
                    <tr style="cursor: pointer;" onclick="explorerSearchTxid('${tx.txid}')">
                      <td class="truncate" title="${tx.txid}" style="max-width: 150px;">${tx.txid}</td>
                      <td>
                        <span class="badge ${tx.category === 'receive' || tx.category === 'generate' ? 'badge-success' : 'badge-danger'}">
                          ${tx.category}
                        </span>
                      </td>
                      <td style="color: ${tx.amount >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                        ${tx.amount >= 0 ? '+' : ''}${tx.amount.toFixed(8)} BTC
                      </td>
                      <td>${tx.confirmations}</td>
                      <td>${tx.time ? new Date(tx.time * 1000).toLocaleString() : 'Pending'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else {
          document.getElementById('addressTransactions').innerHTML = `
            <div class="empty-state">
              No transactions found for this address.
              <br><br>
              <span style="font-size: 0.85rem; color: var(--text-secondary);">
                ${electrsData ? 'This address has no transaction history.' : 'Electrs is not available. Only wallet addresses can be queried.'}
              </span>
            </div>
          `;
        }

      } catch (error) {
        showExplorerError('Error looking up address: ' + error.message);
        throw error;
      }
    }

    // Helper functions to search from links
    function explorerSearchAddress(address) {
      document.getElementById('explorerSearch').value = address;
      explorerLookup();
    }

    function explorerSearchTxid(txid) {
      document.getElementById('explorerSearch').value = txid;
      explorerLookup();
    }

    // Allow Enter key to trigger search
    document.addEventListener('DOMContentLoaded', () => {
      const explorerInput = document.getElementById('explorerSearch');
      if (explorerInput) {
        explorerInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            explorerLookup();
          }
        });
      }
    });

    // Refresh all data
    async function refreshAll() {
      await checkConnection();
      await checkElectrsConnection();
      await refreshStats();
      loadMiningInfo();
      loadWalletInfo();
      loadUTXOs();
      loadRecentTransactions();
      loadElectrsInfo();
      loadMempoolInfo();
      loadRecentBlocks();
    }

    // Theme Management
    const defaultTheme = {
      accent: '#3b82f6',
      bg: '#0a0f17',
      card: '#111827',
      text: '#f0f6fc'
    };

    const presets = {
      // Dark themes
      bitcoin: { accent: '#f7931a', bg: '#0d1117', card: '#161b22', text: '#f0f6fc' },
      green: { accent: '#22c55e', bg: '#0a0f0a', card: '#111a11', text: '#f0f6fc' },
      blue: { accent: '#3b82f6', bg: '#0a0f17', card: '#111827', text: '#f0f6fc' },
      purple: { accent: '#a855f7', bg: '#0f0a17', card: '#1a1127', text: '#f0f6fc' },
      red: { accent: '#ef4444', bg: '#170a0a', card: '#271111', text: '#f0f6fc' },
      pink: { accent: '#ec4899', bg: '#170a11', card: '#27111a', text: '#f0f6fc' },
      teal: { accent: '#14b8a6', bg: '#0a1717', card: '#112222', text: '#f0f6fc' },
      yellow: { accent: '#eab308', bg: '#17150a', card: '#222011', text: '#f0f6fc' },
      // Light themes
      lightBlue: { accent: '#3b82f6', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' },
      lightGreen: { accent: '#22c55e', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' },
      lightPurple: { accent: '#a855f7', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' },
      lightOrange: { accent: '#f7931a', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' },
      lightGray: { accent: '#64748b', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' },
      lightTeal: { accent: '#14b8a6', bg: '#f8fafc', card: '#ffffff', text: '#1e293b' }
    };

    function toggleThemePanel() {
      document.getElementById('themePanel').classList.toggle('open');
      document.getElementById('themePanelOverlay').classList.toggle('open');
    }

    function updateColor(type, value) {
      const root = document.documentElement;

      switch(type) {
        case 'accent':
          root.style.setProperty('--accent-orange', value);
          document.getElementById('accentColorText').value = value;
          document.getElementById('accentColor').value = value;
          break;
        case 'bg':
          root.style.setProperty('--bg-primary', value);
          document.getElementById('bgColorText').value = value;
          document.getElementById('bgColor').value = value;
          // Also update tertiary bg
          root.style.setProperty('--bg-tertiary', adjustColor(value, 20));
          root.style.setProperty('--border-color', adjustColor(value, 35));
          break;
        case 'card':
          root.style.setProperty('--bg-secondary', value);
          document.getElementById('cardColorText').value = value;
          document.getElementById('cardColor').value = value;
          break;
        case 'text':
          root.style.setProperty('--text-primary', value);
          root.style.setProperty('--text-secondary', adjustColor(value, -40));
          document.getElementById('textColorText').value = value;
          document.getElementById('textColor').value = value;
          break;
      }

      saveTheme();
      updateThemeButtonVisibility();
    }

    function updateColorFromText(type, value) {
      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        updateColor(type, value);
      }
    }

    function adjustColor(hex, amount) {
      const num = parseInt(hex.slice(1), 16);
      const r = Math.min(255, Math.max(0, (num >> 16) + amount));
      const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
      const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
      return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // Calculate relative luminance of a color (WCAG formula)
    function getLuminance(hex) {
      const num = parseInt(hex.slice(1), 16);
      const r = (num >> 16) / 255;
      const g = ((num >> 8) & 0x00FF) / 255;
      const b = (num & 0x0000FF) / 255;

      const toLinear = (c) => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);

      return 0.2126 * toLinear(r) + 0.7152 * toLinear(g) + 0.0722 * toLinear(b);
    }

    // Calculate contrast ratio between two colors
    function getContrastRatio(hex1, hex2) {
      const l1 = getLuminance(hex1);
      const l2 = getLuminance(hex2);
      const lighter = Math.max(l1, l2);
      const darker = Math.min(l1, l2);
      return (lighter + 0.05) / (darker + 0.05);
    }

    // Update theme panel buttons to ensure visibility
    function updateThemeButtonVisibility() {
      const resetBtn = document.getElementById('themeResetBtn');
      const doneBtn = document.getElementById('themeDoneBtn');
      if (!resetBtn || !doneBtn) return;

      // Get current colors
      const styles = getComputedStyle(document.documentElement);
      const bgColor = styles.getPropertyValue('--bg-tertiary').trim() || '#21262d';
      const textColor = styles.getPropertyValue('--text-primary').trim() || '#f0f6fc';
      const accentColor = styles.getPropertyValue('--accent-orange').trim() || '#3b82f6';
      const panelBg = styles.getPropertyValue('--bg-secondary').trim() || '#161b22';

      // Check contrast for Reset button (btn-secondary uses bg-tertiary)
      const resetBgContrast = getContrastRatio(bgColor, panelBg);
      const resetTextContrast = getContrastRatio(textColor, bgColor);

      // Check contrast for Done button (btn-primary uses accent color)
      const doneBgContrast = getContrastRatio(accentColor, panelBg);

      // Minimum contrast ratio for visibility (WCAG AA is 4.5, we use 2.5 for buttons)
      const minContrast = 2.5;

      // Reset button - add high-contrast border if background blends
      if (resetBgContrast < minContrast || resetTextContrast < minContrast) {
        // Use inverted colors for high contrast
        const isLightBg = getLuminance(panelBg) > 0.5;
        resetBtn.style.background = isLightBg ? '#1f2937' : '#e5e7eb';
        resetBtn.style.color = isLightBg ? '#ffffff' : '#1f2937';
        resetBtn.style.border = isLightBg ? '2px solid #374151' : '2px solid #9ca3af';
      } else {
        resetBtn.style.background = '';
        resetBtn.style.color = '';
        resetBtn.style.border = '';
      }

      // Done button - ensure accent color is visible
      if (doneBgContrast < minContrast) {
        const isLightBg = getLuminance(panelBg) > 0.5;
        doneBtn.style.background = isLightBg ? '#1d4ed8' : '#60a5fa';
        doneBtn.style.border = isLightBg ? '2px solid #1e40af' : '2px solid #93c5fd';
      } else {
        doneBtn.style.background = '';
        doneBtn.style.border = '';
      }
    }

    function applyPreset(name) {
      const preset = presets[name];
      if (preset) {
        updateColor('accent', preset.accent);
        updateColor('bg', preset.bg);
        updateColor('card', preset.card);
        updateColor('text', preset.text);
      }
    }

    function saveTheme() {
      const theme = {
        accent: document.getElementById('accentColor').value,
        bg: document.getElementById('bgColor').value,
        card: document.getElementById('cardColor').value,
        text: document.getElementById('textColor').value
      };
      localStorage.setItem('dashboardTheme', JSON.stringify(theme));
    }

    function loadTheme() {
      const saved = localStorage.getItem('dashboardTheme');
      if (saved) {
        try {
          const theme = JSON.parse(saved);
          updateColor('accent', theme.accent);
          updateColor('bg', theme.bg);
          updateColor('card', theme.card);
          updateColor('text', theme.text);
        } catch (e) {
          console.log('Failed to load theme:', e);
        }
      }
    }

    function resetTheme() {
      localStorage.removeItem('dashboardTheme');
      updateColor('accent', defaultTheme.accent);
      updateColor('bg', defaultTheme.bg);
      updateColor('card', defaultTheme.card);
      updateColor('text', defaultTheme.text);
    }

    // Chain Reset Functions
    function showResetConfirm() {
      document.getElementById('resetModal').style.display = 'flex';
      document.getElementById('resetConfirmInput').value = '';
      document.getElementById('resetConfirmInput').focus();
    }

    function hideResetModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    async function executeReset() {
      const confirmValue = document.getElementById('resetConfirmInput').value;

      if (confirmValue !== 'RESET') {
        alert('Please type RESET to confirm.');
        return;
      }

      hideResetModal();

      try {
        const result = await api('/chain/reset', {
          method: 'POST',
          body: JSON.stringify({ confirm: 'RESET' })
        });

        showResult('resetResult', result);

        // Refresh all stats
        setTimeout(() => {
          refreshAll();
        }, 1000);

      } catch (error) {
        showResult('resetResult', error.message, true);
      }
    }

    async function reconsiderChain() {
      if (!confirm('This will restore any previously invalidated blocks. Continue?')) {
        return;
      }

      try {
        const result = await api('/chain/reconsider', {
          method: 'POST',
          body: JSON.stringify({})
        });

        showResult('resetResult', result);

        // Refresh all stats
        setTimeout(() => {
          refreshAll();
        }, 1000);

      } catch (error) {
        showResult('resetResult', error.message, true);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      updateThemeButtonVisibility();
      refreshAll();
      // Auto-refresh every 10 seconds
      setInterval(refreshStats, 10000);
      setInterval(checkConnection, 30000);
      setInterval(checkElectrsConnection, 30000);
    });
  </script>
</body>
</html>
